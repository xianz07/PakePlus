<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èœœé›ªã®æ¯æ—¥ä½œæˆ˜é¢æ¿ </title>
    <style>
        /* CSS æ ·å¼ - ç”¨äºç¾åŒ–ç•Œé¢å’Œç§»åŠ¨ç«¯é€‚é… */
        :root {
            --primary-color: #007bff;
            --secondary-color: #f0f0f0;
            --border-color: #ddd;
            --text-color: #333;
            --bg-color: #fff;
            --success-color: #28a745;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            padding: 15px;
            font-size: 16px;
            line-height: 1.6;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--bg-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 1.5em;
        }
        .input-group {
            margin-bottom: 18px;
        }
        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 6px;
            color: #555;
        }
        .input-group input[type="number"],
        .input-group input[type="text"],
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        .weather-options {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .weather-options input[type="radio"] {
            display: none;
        }
        .weather-options label {
            flex-grow: 1;
            text-align: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        .weather-options input[type="radio"]:checked + label {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .batch-paste textarea {
            height: 120px;
            resize: vertical;
        }
        .readonly-field {
            background-color: #e9ecef;
            font-weight: bold;
        }
        .summary-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .summary-group input {
            flex-grow: 1;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        .output-section {
            margin-top: 30px;
            border-top: 2px solid var(--secondary-color);
            padding-top: 20px;
        }
        #resultTemplate {
            width: 100%;
            height: 300px;
            font-family: monospace;
            white-space: pre;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background-color: #f8f9fa;
        }
        #copyButton {
            width: 100%;
            padding: 15px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: background-color 0.3s;
        }
        #copyButton:hover {
            background-color: #218838;
        }
        .inline-label {
            font-weight: normal; 
            margin-left: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>è¥ä¸šã®æ—¥å¿—</h1>

    <!-- æ—¥æœŸ (è‡ªåŠ¨) -->
    <div class="input-group">
        <label for="dateDisplay">æ—¥æœŸ</label>
        <input type="text" id="dateDisplay" readonly class="readonly-field">
    </div>

    <!-- å¤©æ°” -->
    <div class="input-group">
        <label>ä»Šå¤©çš„å¤©æ°”æ˜¯ï¼Ÿ</label>
        <div class="weather-options">
            <input type="radio" id="weather_sunny" name="weather_choice" value="æ™´" checked>
            <label for="weather_sunny">â˜€ï¸ æ™´</label>
            <input type="radio" id="weather_rainy" name="weather_choice" value="é›¨">
            <label for="weather_rainy">ğŸŒ§ï¸ é›¨</label>
            <input type="radio" id="weather_cloudy" name="weather_choice" value="é˜´">
            <label for="weather_cloudy">â˜ï¸ é˜´</label>
        </div>
        <input type="text" id="weather_manual" placeholder="ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œæ‰‹åŠ¨å¡«å†™å¤©æ°”å–µ">
    </div>

    <!-- æ‰¹é‡ç²˜è´´ -->
    <div class="input-group batch-paste">
        <label for="batchPaste">ç²˜è´´åŒºåŸŸ (æ•°æ®è¦æ ¸å¯¹æ¸…æ¥šå“¦)</label>
        <textarea id="batchPaste" placeholder="æ ¼å¼ç¤ºä¾‹ï¼š&#10;ç¾å›¢ï¼š621.53&#10;é¥¿ï¼š306.56&#10;äº¬ï¼š78.1&#10;æ‰«ï¼š946.04&#10;ç°ï¼š104.90"></textarea>
    </div>

    <!-- å„é¡¹æ”¶å…¥ -->
    <div class="input-group">
        <label for="jd">äº¬ä¸œ</label>
        <input type="number" id="jd" placeholder="0.00" step="0.01">
    </div>
    <div class="input-group">
        <label for="meituan">ç¾å›¢</label>
        <input type="number" id="meituan" placeholder="0.00" step="0.01">
    </div>
    <div class="input-group">
        <label for="eleme">é¥¿äº†ä¹ˆ</label>
        <input type="number" id="eleme" placeholder="0.00" step="0.01">
    </div>
    <div class="input-group">
        <label for="mobilePay">ç§»åŠ¨æ”¯ä»˜</label>
        <input type="number" id="mobilePay" placeholder="0.00" step="0.01">
    </div>
    <div class="input-group">
        <label for="cash">ç°é‡‘</label>
        <input type="number" id="cash" placeholder="0.00" step="0.01">
    </div>

    <!-- è‡ªåŠ¨è®¡ç®—éƒ¨åˆ† -->
    <div class="input-group">
        <label for="turnover">å½“æ—¥è¥ä¸šé¢</label>
        <input type="number" id="turnover" readonly class="readonly-field">
    </div>

    <!-- æ–°å¢éƒ¨åˆ† START -->
    <div class="input-group">
        <label for="lastMonthlyTotalInput">ä¸Šæ¬¡æ±‡æ€» æ±‡æ€»è®¡ç®—é”™è¯¯å°±æ”¹è¿™é‡Œå–µ</label>
        <input type="number" id="lastMonthlyTotalInput" placeholder="0.00" step="0.01">
    </div>
    <!-- æ–°å¢éƒ¨åˆ† END -->

    <div class="input-group">
        <label for="monthlyTotal">æœ¬æœˆæ±‡æ€»</label>
        <div class="summary-group">
            <input type="number" id="monthlyTotal" placeholder="0.00" step="0.01">
            <label class="toggle-switch">
                <input type="checkbox" id="autoCalcToggle" checked>
                <span class="slider"></span>
            </label>
            <span class="inline-label">è‡ªåŠ¨</span>
        </div>
    </div>
    
    <div class="input-group">
        <label for="monthlyTarget">æœˆç›®æ ‡</label>
        <input type="number" id="monthlyTarget" placeholder="ä¾‹å¦‚: 70000" step="100">
    </div>

    <div class="input-group">
        <label for="completionRate">å®Œæˆç‡</label>
        <input type="text" id="completionRate" readonly class="readonly-field">
    </div>
    
    <!-- è¯„åˆ† -->
    <div class="input-group">
        <label for="meituanRating">ç¾å›¢è¯„åˆ†</label>
        <input type="number" id="meituanRating" step="0.1" placeholder="ä¾‹å¦‚: 4.9">
    </div>
    <div class="input-group">
        <label for="elemeRating">é¥¿äº†ä¹ˆè¯„åˆ†</label>
        <input type="number" id="elemeRating" step="0.1" placeholder="ä¾‹å¦‚: 4.8">
    </div>

    <!-- è¾“å‡ºç»“æœ -->
    <div class="output-section">
        <h2>ç”Ÿæˆç»“æœ</h2>
        <textarea id="resultTemplate" readonly></textarea>
        <button id="copyButton">ç‚¹æˆ‘å¤åˆ¶åˆ°å‰ªè´´æ¿å–µ</button>
    </div>

</div>

<script>
// JavaScript é€»è¾‘ - å®ç°æ‰€æœ‰åŠ¨æ€åŠŸèƒ½
document.addEventListener('DOMContentLoaded', () => {
    // 1. è·å–æ‰€æœ‰DOMå…ƒç´ 
    const elements = {
        dateDisplay: document.getElementById('dateDisplay'),
        weatherRadios: document.querySelectorAll('input[name="weather_choice"]'),
        weatherManual: document.getElementById('weather_manual'),
        batchPaste: document.getElementById('batchPaste'),
        jd: document.getElementById('jd'),
        meituan: document.getElementById('meituan'),
        eleme: document.getElementById('eleme'),
        mobilePay: document.getElementById('mobilePay'),
        cash: document.getElementById('cash'),
        turnover: document.getElementById('turnover'),
        //- ä¿®æ”¹ç‚¹ï¼šæ–°å¢ lastMonthlyTotalInput å…ƒç´ 
        lastMonthlyTotalInput: document.getElementById('lastMonthlyTotalInput'),
        monthlyTotal: document.getElementById('monthlyTotal'),
        autoCalcToggle: document.getElementById('autoCalcToggle'),
        monthlyTarget: document.getElementById('monthlyTarget'),
        completionRate: document.getElementById('completionRate'),
        meituanRating: document.getElementById('meituanRating'),
        elemeRating: document.getElementById('elemeRating'),
        resultTemplate: document.getElementById('resultTemplate'),
        copyButton: document.getElementById('copyButton'),
    };

    // 2. æœ¬åœ°å­˜å‚¨çš„é”®
    const STORAGE_KEYS = {
        //- ä¿®æ”¹ç‚¹ï¼šè¿™ä¸ªé”®ç°åœ¨æ˜¯ä¸º â€œä¸Šæ¬¡æ±‡æ€»â€ è¾“å…¥æ¡†æœåŠ¡çš„
        LAST_MONTHLY_TOTAL: 'dailyReport_lastMonthlyTotal',
        MONTHLY_TARGET: 'dailyReport_monthlyTarget',
        MEITUAN_RATING: 'dailyReport_meituanRating',
        ELEME_RATING: 'dailyReport_elemeRating',
    };
    
    //- ä¿®æ”¹ç‚¹ï¼šè¿™ä¸ªå˜é‡ä¸å†éœ€è¦åœ¨å…¨å±€ä½œç”¨åŸŸä¸­ï¼Œå®ƒçš„å€¼å°†ç›´æ¥ä»è¾“å…¥æ¡†è¯»å–
    // let lastMonthlyTotal = 0; 

    // 3. åˆå§‹åŒ–é¡µé¢
    function initialize() {
        // è®¾ç½®è‡ªåŠ¨æ—¥æœŸ
        const today = new Date();
        elements.dateDisplay.value = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;

        // ä»localStorageåŠ è½½æ•°æ®
        loadDataFromStorage();

        // ç»‘å®šæ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
        setupEventListeners();

        // åˆå§‹è®¡ç®—å’Œæ›´æ–°
        updateAll();
    }

    // 4. ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
    function loadDataFromStorage() {
        //- ä¿®æ”¹ç‚¹ï¼šåŠ è½½ä¸Šæ¬¡æ±‡æ€»å€¼å¹¶ç›´æ¥å¡«å……åˆ°æ–°çš„è¾“å…¥æ¡†ä¸­
        const lastMonthlyTotal = parseFloat(localStorage.getItem(STORAGE_KEYS.LAST_MONTHLY_TOTAL)) || 0;
        elements.lastMonthlyTotalInput.value = lastMonthlyTotal.toFixed(2);
        
        // åŠ è½½å…¶ä»–è®°å¿†é¡¹
        elements.monthlyTarget.value = localStorage.getItem(STORAGE_KEYS.MONTHLY_TARGET) || '';
        elements.meituanRating.value = localStorage.getItem(STORAGE_KEYS.MEITUAN_RATING) || '4.9';
        elements.elemeRating.value = localStorage.getItem(STORAGE_KEYS.ELEME_RATING) || '4.8';
        
        // é»˜è®¤å¼€å¯è‡ªåŠ¨è®¡ç®—
        elements.autoCalcToggle.checked = true;
    }
    
    // 5. è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        //- ä¿®æ”¹ç‚¹ï¼šå°† lastMonthlyTotalInput æ·»åŠ åˆ°ç›‘å¬åˆ—è¡¨
        const inputsToWatch = [elements.jd, elements.meituan, elements.eleme, elements.mobilePay, elements.cash, elements.monthlyTarget, elements.meituanRating, elements.elemeRating, elements.monthlyTotal, elements.weatherManual, elements.lastMonthlyTotalInput];
        inputsToWatch.forEach(input => input.addEventListener('input', updateAll));

        elements.weatherRadios.forEach(radio => radio.addEventListener('change', () => {
             // é€‰æ‹©å¤©æ°”å¡ç‰‡æ—¶ï¼Œæ¸…ç©ºæ‰‹åŠ¨è¾“å…¥æ¡†
            elements.weatherManual.value = '';
            updateAll();
        }));
        
        elements.weatherManual.addEventListener('input', () => {
            // æ‰‹åŠ¨è¾“å…¥å¤©æ°”æ—¶ï¼Œå–æ¶ˆæ‰€æœ‰å¤©æ°”å¡ç‰‡çš„é€‰æ‹©
            if(elements.weatherManual.value) {
                elements.weatherRadios.forEach(radio => radio.checked = false);
            }
            updateAll();
        });

        elements.autoCalcToggle.addEventListener('change', updateAll);
        elements.batchPaste.addEventListener('input', handleBatchPaste);
        elements.copyButton.addEventListener('click', copyToClipboard);
    }

    // 6. å¤„ç†æ‰¹é‡ç²˜è´´
    function handleBatchPaste() {
        const text = elements.batchPaste.value;
        const lines = text.split('\n');
        const patterns = {
            meituan: /(?:ç¾å›¢|mt)[:ï¼š\s]*([\d.]+)/i,
            eleme: /(?:é¥¿äº†ä¹ˆ|é¥¿)[:ï¼š\s]*([\d.]+)/i,
            jd: /(?:äº¬ä¸œ|äº¬)[:ï¼š\s]*([\d.]+)/i,
            mobilePay: /(?:ç§»åŠ¨æ”¯ä»˜|æ‰«ç |æ‰«)[:ï¼š\s]*([\d.]+)/i,
            cash: /(?:ç°é‡‘|ç°)[:ï¼š\s]*([\d.]+)/i,
        };

        lines.forEach(line => {
            for (const key in patterns) {
                const match = line.match(patterns[key]);
                if (match && match[1]) {
                    elements[key].value = parseFloat(match[1]).toFixed(2);
                }
            }
        });
        updateAll();
    }

    // 7. æ ¸å¿ƒæ›´æ–°å‡½æ•°ï¼šè®¡ç®—æ‰€æœ‰æ•°æ®å¹¶æ›´æ–°ç•Œé¢
    function updateAll() {
        // a. è·å–æ‰€æœ‰è¾“å…¥å€¼ï¼Œå¹¶è½¬ä¸ºæ•°å­—ï¼ˆå¤„ç†ç©ºå€¼ï¼‰
        const jd = parseFloat(elements.jd.value) || 0;
        const meituan = parseFloat(elements.meituan.value) || 0;
        const eleme = parseFloat(elements.eleme.value) || 0;
        const mobilePay = parseFloat(elements.mobilePay.value) || 0;
        const cash = parseFloat(elements.cash.value) || 0;
        
        // b. è®¡ç®—å½“æ—¥è¥ä¸šé¢
        const dailyTurnover = jd + meituan + eleme + mobilePay + cash;
        elements.turnover.value = dailyTurnover.toFixed(2);

        // c. è®¡ç®—æœ¬æœˆæ±‡æ€»
        let currentMonthlyTotal = 0;
        //- ä¿®æ”¹ç‚¹ï¼šè·å– â€œä¸Šæ¬¡æ±‡æ€»â€ è¾“å…¥æ¡†çš„æœ€æ–°å€¼
        const lastTotalFromInput = parseFloat(elements.lastMonthlyTotalInput.value) || 0;

        if (elements.autoCalcToggle.checked) {
            elements.monthlyTotal.readOnly = true;
            elements.monthlyTotal.classList.add('readonly-field');
            //- ä¿®æ”¹ç‚¹ï¼šä½¿ç”¨è¾“å…¥æ¡†çš„å€¼è¿›è¡Œè®¡ç®—
            currentMonthlyTotal = lastTotalFromInput + dailyTurnover;
            elements.monthlyTotal.value = currentMonthlyTotal.toFixed(2);
        } else {
            elements.monthlyTotal.readOnly = false;
            elements.monthlyTotal.classList.remove('readonly-field');
            currentMonthlyTotal = parseFloat(elements.monthlyTotal.value) || 0;
        }

        // d. è®¡ç®—å®Œæˆç‡
        const monthlyTarget = parseFloat(elements.monthlyTarget.value) || 0;
        let completionRate = 0;
        if (monthlyTarget > 0) {
            completionRate = (currentMonthlyTotal / monthlyTarget) * 100;
        }
        elements.completionRate.value = `${completionRate.toFixed(2)}%`;
        
        // e. ä¿å­˜éœ€è¦è®°å¿†çš„æ•°æ®åˆ°localStorage
        //- ä¿®æ”¹ç‚¹ï¼šä¿å­˜çš„æ˜¯æœ€ç»ˆè®¡ç®—å‡ºçš„ â€œæœ¬æœˆæ±‡æ€»â€ å€¼ï¼Œä½œä¸ºä¸‹ä¸€æ¬¡çš„ â€œä¸Šæ¬¡æ±‡æ€»â€
        localStorage.setItem(STORAGE_KEYS.LAST_MONTHLY_TOTAL, currentMonthlyTotal.toFixed(2));
        localStorage.setItem(STORAGE_KEYS.MONTHLY_TARGET, elements.monthlyTarget.value);
        localStorage.setItem(STORAGE_KEYS.MEITUAN_RATING, elements.meituanRating.value);
        localStorage.setItem(STORAGE_KEYS.ELEME_RATING, elements.elemeRating.value);

        // f. ç”Ÿæˆæœ€ç»ˆçš„æ¨¡æ¿æ–‡æœ¬
        generateTemplate();
    }

    // 8. ç”Ÿæˆæ¨¡æ¿æ–‡æœ¬
    function generateTemplate() {
        // è·å–å¤©æ°”
        let weather = '';
        if (elements.weatherManual.value) {
            weather = elements.weatherManual.value;
        } else {
            const checkedRadio = document.querySelector('input[name="weather_choice"]:checked');
            if(checkedRadio) weather = checkedRadio.value;
        }

        const data = {
            date: elements.dateDisplay.value,
            weather: weather,
            turnover: (parseFloat(elements.turnover.value) || 0).toFixed(2),
            jd: (parseFloat(elements.jd.value) || 0).toFixed(2),
            meituan: (parseFloat(elements.meituan.value) || 0).toFixed(2),
            eleme: (parseFloat(elements.eleme.value) || 0).toFixed(2),
            mobilePay: (parseFloat(elements.mobilePay.value) || 0).toFixed(2),
            cash: (parseFloat(elements.cash.value) || 0).toFixed(2),
            monthlyTotal: (parseFloat(elements.monthlyTotal.value) || 0).toFixed(2),
            monthlyTarget: (parseFloat(elements.monthlyTarget.value) / 10000).toLocaleString('zh-CN', {minimumFractionDigits: 0, maximumFractionDigits: 1}) + 'ä¸‡', // æ ¼å¼åŒ–ä¸ºx.xä¸‡
            completionRate: elements.completionRate.value,
            meituanRating: elements.meituanRating.value,
            elemeRating: elements.elemeRating.value,
        };
        
        const template = `æ–°ä¸–çºªåº—${data.date}
å¤©æ°”:${data.weather}
è¥ä¸šé¢ï¼š${data.turnover}
äº¬ä¸œï¼š${data.jd}
ç¾å›¢ï¼š${data.meituan}
é¥¿äº†ä¹ˆï¼š${data.eleme}
ç§»åŠ¨æ”¯ä»˜ï¼š${data.mobilePay}
ç°é‡‘ï¼š${data.cash}
æ±‡æ€»:${data.monthlyTotal}
æœˆç›®æ ‡${data.monthlyTarget}å®Œæˆ:${data.completionRate}
ç¾å›¢è¯„åˆ†ï¼š${data.meituanRating}åˆ†
é¥¿äº†ä¹ˆè¯„åˆ†ï¼š${data.elemeRating}åˆ†`;

        elements.resultTemplate.value = template;
    }

    // 9. å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½
    function copyToClipboard() {
        if (!navigator.clipboard) {
            // å…¼å®¹æ—§ç‰ˆæµè§ˆå™¨
            elements.resultTemplate.select();
            document.execCommand('copy');
            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ (æ—§ç‰ˆæ¨¡å¼)');
            return;
        }
        navigator.clipboard.writeText(elements.resultTemplate.value).then(() => {
            const originalText = elements.copyButton.textContent;
            elements.copyButton.textContent = 'âœ… å·²å¤åˆ¶ï¼';
            elements.copyButton.style.backgroundColor = '#1e7e34';
            setTimeout(() => {
                elements.copyButton.textContent = originalText;
                elements.copyButton.style.backgroundColor = 'var(--success-color)';
            }, 1500);
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥: ', err);
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
        });
    }

    // å¯åŠ¨ï¼
    initialize();
});
</script>

</body>
</html>